# üöÄ PLANO DE A√á√ÉO PROFISSIONAL - N√îA ESPERANZA 3.0
## An√°lise + Implementa√ß√£o Imediata

**Data:** 01 de Outubro de 2025  
**Baseado em:** Avalia√ß√£o T√©cnica Profissional  
**Status Atual:** 85% ‚Üí Objetivo: 95% (Produ√ß√£o)

---

## üéØ **AN√ÅLISE RECEBIDA - RESUMO:**

### ‚úÖ **O QUE J√Å EST√Å BOM:**
- Backend estruturado (Supabase)
- Frontend funcional
- 559 aprendizados salvos
- IA integrada (por√©m subutilizada)

### ‚ö†Ô∏è **PRIORIDADES CR√çTICAS:**
1. üî• **NoaGPT n√£o busca no banco antes de responder**
2. üî• **Home.tsx faz tudo (n√£o escala)**
3. üî• **Falta retomada de sess√£o**
4. ‚ö†Ô∏è **Vari√°veis [queixa] falham em 2 casos**
5. ‚ö†Ô∏è **Falta logs estruturados para auditoria**

---

## üìã **SPRINT 1 - REFATORA√á√ÉO ESTRUTURAL (Esta Semana)**

### **üî• PRIORIDADE 1: Integrar Busca de Aprendizado no NoaGPT**

#### **Problema Atual:**
```typescript
// noaGPT.ts - HOJE
async processCommand(message: string) {
  // Vai direto pro OpenAI sem checar banco!
  return await openaiService.chat(message)
}
```

#### **Solu√ß√£o:**
```typescript
// noaGPT.ts - NOVO
async processCommand(message: string) {
  // 1. BUSCA NO BANCO PRIMEIRO
  const aprendizados = await aiSmartLearningService.buscar(message)
  
  if (aprendizados.length > 0 && aprendizados[0].confidence > 0.7) {
    console.log('‚úÖ Usando aprendizado do banco!')
    return this.usarAprendizado(aprendizados[0])
  }
  
  // 2. S√ì DEPOIS VAI PRO OPENAI
  console.log('üîÑ Fallback para OpenAI')
  const response = await openaiService.chat(message)
  
  // 3. SALVA O QUE APRENDEU
  await this.salvarAprendizado(message, response)
  
  return response
}
```

**Ganho:** -50% custos OpenAI + Respostas mais r√°pidas + IA aprende continuamente

---

### **üî• PRIORIDADE 2: Criar chatController.ts**

#### **Problema Atual:**
```typescript
// Home.tsx - HOJE (2.581 linhas!)
const getNoaResponse = async (userMessage: string) => {
  // Faz TUDO aqui:
  if (isAdmin) { ... }          // Admin
  if (isAvaliacao) { ... }      // Avalia√ß√£o
  if (isPerfil) { ... }         // Perfil
  if (isComando) { ... }        // Comando
  // ... mais 50 IFs
}
```

#### **Solu√ß√£o:**
```typescript
// chatController.ts - NOVO
export class ChatController {
  async processar(message: string, context: Context) {
    // 1. DETECTA INTEN√á√ÉO
    const intent = await this.detectIntent(message)
    
    // 2. ROTEIA PARA SERVI√áO CORRETO
    switch(intent.type) {
      case 'admin':
        return adminCommandService.executar(message, context)
      
      case 'avaliacao_clinica':
        return avaliacaoClinicaService.processar(message, context)
      
      case 'perfil':
        return perfilService.atualizar(message, context)
      
      case 'curso':
        return cursoService.responder(message, context)
      
      default:
        return chatFlowService.conversaNormal(message, context)
    }
  }
  
  private async detectIntent(message: string) {
    // Busca no banco + an√°lise sem√¢ntica
    return aiSmartLearningService.detectarIntencao(message)
  }
}
```

**Ganho:** Home.tsx reduz de 2.581 ‚Üí ~800 linhas + Manuten√ß√£o f√°cil + Escal√°vel

---

### **üî• PRIORIDADE 3: Sistema de Retomada de Sess√£o**

#### **Problema Atual:**
```typescript
// Usu√°rio no bloco 15/28
// Fecha navegador
// Abre de novo
// ‚ùå Come√ßa do ZERO!
```

#### **Solu√ß√£o:**
```typescript
// sessionService.ts - NOVO
export class SessionService {
  async salvar(sessionId: string, estado: any) {
    await supabase.from('sessoes_em_andamento').upsert({
      session_id: sessionId,
      etapa_atual: estado.etapa,
      respostas: estado.respostas,
      timestamp: new Date(),
      usuario_id: estado.userId
    })
  }
  
  async retomar(userId: string) {
    const { data } = await supabase
      .from('sessoes_em_andamento')
      .select('*')
      .eq('usuario_id', userId)
      .order('timestamp', { ascending: false })
      .limit(1)
      .single()
    
    if (data && data.etapa_atual < 28) {
      return {
        temSessao: true,
        etapa: data.etapa_atual,
        respostas: data.respostas,
        mensagem: `Voc√™ estava no bloco ${data.etapa_atual}/28. Deseja continuar?`
      }
    }
    
    return { temSessao: false }
  }
}
```

**Uso no Home.tsx:**
```typescript
useEffect(() => {
  const verificarSessao = async () => {
    const sessao = await sessionService.retomar(userId)
    
    if (sessao.temSessao) {
      setMensagens([{
        sender: 'noa',
        text: sessao.mensagem,
        buttons: ['‚úÖ Continuar', 'üîÑ Come√ßar de Novo']
      }])
    }
  }
  
  verificarSessao()
}, [userId])
```

**Ganho:** Fideliza√ß√£o + Dados consistentes + Experi√™ncia profissional

---

### **‚ö†Ô∏è PRIORIDADE 4: Corrigir Substitui√ß√£o de Vari√°veis**

#### **Problema Atual:**
```typescript
// Blocos 5, 7, 8 retornam:
"Como √© a [queixa]?" // ‚ùå N√£o substitui!
```

#### **Solu√ß√£o Robusta:**
```typescript
// avaliacaoClinicaService.ts - MELHORADO
substituirVariaveis(texto: string, variaveis: Record<string, string>): string {
  let resultado = texto
  
  // 1. Substitui todas as vari√°veis conhecidas
  Object.entries(variaveis).forEach(([key, value]) => {
    const regex = new RegExp(`\\[${key}\\]`, 'gi')
    resultado = resultado.replace(regex, value || key)
  })
  
  // 2. NOVO: Substitui vari√°veis gen√©ricas
  const variavelGenerica = /\[(\w+)\]/g
  resultado = resultado.replace(variavelGenerica, (match, varName) => {
    // Tenta buscar em ordem de prioridade
    return variaveis[varName] || 
           variaveis[varName.toLowerCase()] || 
           variaveis.queixa_principal || 
           'isso'
  })
  
  // 3. Log para debug
  console.log('üîß Substitui√ß√£o:', { original: texto, resultado, variaveis })
  
  return resultado
}
```

**Teste Rigoroso:**
```typescript
// test/substituicaoVariaveis.test.ts
describe('Substitui√ß√£o de Vari√°veis', () => {
  it('Bloco 5 - Localiza√ß√£o', () => {
    const texto = "Onde voc√™ sente [queixa]?"
    const vars = { queixa: "dor de cabe√ßa" }
    const result = substituirVariaveis(texto, vars)
    expect(result).toBe("Onde voc√™ sente dor de cabe√ßa?")
  })
  
  it('Bloco 7 - Caracter√≠sticas', () => {
    const texto = "Como √© a [queixa]?"
    const vars = { queixa: "tontura" }
    const result = substituirVariaveis(texto, vars)
    expect(result).toBe("Como √© a tontura?")
  })
  
  it('Bloco 8 - Sintomas Associados', () => {
    const texto = "O que mais voc√™ sente quando est√° com a [queixa]?"
    const vars = { queixa: "n√°usea" }
    const result = substituirVariaveis(texto, vars)
    expect(result).toBe("O que mais voc√™ sente quando est√° com a n√°usea?")
  })
})
```

**Ganho:** 100% de substitui√ß√£o correta + Confian√ßa cl√≠nica

---

### **‚ö†Ô∏è PRIORIDADE 5: Logs Estruturados para Auditoria**

#### **Solu√ß√£o:**
```typescript
// logService.ts - NOVO
export class LogService {
  async log(evento: string, dados: any, nivel: 'info' | 'warning' | 'error' = 'info') {
    const logEntry = {
      timestamp: new Date().toISOString(),
      evento,
      dados,
      nivel,
      user_id: dados.userId || 'anonimo',
      session_id: dados.sessionId || 'n/a'
    }
    
    // 1. Console para dev
    console.log(`üìä [${nivel.toUpperCase()}] ${evento}:`, dados)
    
    // 2. Supabase para produ√ß√£o
    await supabase.from('logs_sistema').insert(logEntry)
    
    // 3. Arquivo local para backup (opcional)
    if (nivel === 'error') {
      this.salvarArquivo(logEntry)
    }
  }
}
```

**Uso:**
```typescript
// Em qualquer lugar do c√≥digo
await logService.log('bloco_imre_respondido', {
  bloco: 17,
  tempo_resposta: '12s',
  userId: user.id,
  sessionId: currentSession.id,
  texto_pergunta: 'Quais h√°bitos...',
  texto_resposta: 'Fumo cigarro h√° 10 anos'
})

await logService.log('avaliacao_concluida', {
  userId: user.id,
  tempo_total: '18min',
  blocos_completos: 28,
  nft_gerado: nftHash
})

await logService.log('erro_substituicao_variavel', {
  bloco: 7,
  texto_original: '[queixa]',
  variaveis_disponiveis: Object.keys(variaveis)
}, 'error')
```

**Ganho:** Rastreabilidade + Compliance m√©dico + Debug f√°cil

---

## üìã **SPRINT 2 - INTELIG√äNCIA EXPANDIDA (Pr√≥xima Semana)**

### **üß† 1. Embeddings para Busca Sem√¢ntica**

```sql
-- Supabase: Ativar pgvector
CREATE EXTENSION IF NOT EXISTS vector;

-- Adicionar coluna embedding
ALTER TABLE ai_learning 
ADD COLUMN embedding vector(1536);

-- Criar √≠ndice
CREATE INDEX ON ai_learning 
USING ivfflat (embedding vector_cosine_ops);
```

```typescript
// aiSmartLearningService.ts - UPGRADE
async buscarSemantico(query: string) {
  // 1. Gera embedding da pergunta
  const embedding = await openai.embeddings.create({
    model: "text-embedding-ada-002",
    input: query
  })
  
  // 2. Busca similar no banco
  const { data } = await supabase.rpc('busca_semantica', {
    query_embedding: embedding.data[0].embedding,
    limite: 5,
    threshold: 0.8
  })
  
  return data
}
```

**Ganho:** Busca inteligente + Contexto rico + Menos depend√™ncia de LLM

---

### **üé® 2. Dashboard Admin com Log de Decis√µes IA**

```typescript
// DashboardAdmin.tsx - NOVA SE√á√ÉO
<div className="kpi-section">
  <h3>üß† Decis√µes da IA (√öltimas 24h)</h3>
  
  <div className="decisoes-grid">
    {decisoes.map(d => (
      <div className="decisao-card">
        <span className="badge">{d.tipo}</span>
        <p>Pergunta: {d.pergunta}</p>
        <p>Fonte: {d.fonte === 'banco' ? '‚úÖ Banco' : 'üîÑ OpenAI'}</p>
        <p>Confian√ßa: {d.confianca}%</p>
        <p>Tempo: {d.tempo}ms</p>
      </div>
    ))}
  </div>
  
  <div className="metricas">
    <div>Banco: {stats.usoBanco}%</div>
    <div>OpenAI: {stats.usoOpenAI}%</div>
    <div>Economia: R$ {stats.economia}</div>
  </div>
</div>
```

**Ganho:** Transpar√™ncia + Otimiza√ß√£o + ROI vis√≠vel

---

### **üß™ 3. Sistema de Testes A/B**

```typescript
// abTestService.ts
export class ABTestService {
  async testar(userId: string, tipo: 'estilo' | 'fonte' | 'followup') {
    const variante = Math.random() > 0.5 ? 'A' : 'B'
    
    await supabase.from('ab_tests').insert({
      user_id: userId,
      tipo,
      variante,
      timestamp: new Date()
    })
    
    return variante
  }
  
  async registrarResultado(userId: string, satisfacao: number) {
    await supabase.from('ab_tests')
      .update({ satisfacao, concluido: true })
      .eq('user_id', userId)
      .is('concluido', false)
  }
}
```

**Uso:**
```typescript
const estilo = await abTestService.testar(userId, 'estilo')

if (estilo === 'A') {
  // Resposta emp√°tica
  response = "Entendo como deve ser dif√≠cil..."
} else {
  // Resposta t√©cnica
  response = "Segundo a literatura m√©dica..."
}
```

**Ganho:** Dados para otimiza√ß√£o + Personaliza√ß√£o + Ci√™ncia aplicada

---

## üß™ **ESTRUTURA DE TESTES CL√çNICOS**

### **Grupos Piloto:**

| Grupo | Pacientes | Objetivo | Per√≠odo |
|-------|-----------|----------|---------|
| G1 | 10 | Fluxo IMRE completo | 1 semana |
| G2 | 5 | vs. Entrevista presencial | 2 semanas |
| G3 | 15 | Voz + V√≠deo UX | 1 semana |

### **M√©tricas por Grupo:**

```typescript
interface MetricasGrupo {
  feedback_clinico: string[]
  tempo_medio: number // minutos
  taxa_acerto_ia: number // %
  qualidade_relatorio: number // 1-10
  satisfacao_paciente: number // 1-10
  blocos_completos: number // 0-28
}
```

---

## ‚úÖ **CHECKLIST DE PRODU√á√ÉO**

### **Antes de escalar:**

- [ ] Substitui√ß√£o de vari√°veis 100% funcional (testado em 100 casos)
- [ ] IA usa banco antes de OpenAI (logs comprovam >70%)
- [ ] Relat√≥rio final com consist√™ncia cl√≠nica
- [ ] Hash NFT v√°lido e verific√°vel
- [ ] Retomada de sess√£o funciona perfeitamente
- [ ] Logs estruturados salvando tudo
- [ ] Testes A/B rodando
- [ ] Dashboard admin com KPIs em tempo real

---

## üöÄ **ROADMAP ESTRAT√âGICO**

### **Q4 2025 (Out-Dez):**
- ‚úÖ Refatora√ß√£o estrutural completa
- ‚úÖ Testes com 100 pacientes reais
- ‚úÖ Valida√ß√£o cl√≠nica Dr. Ricardo
- ‚úÖ Certifica√ß√£o t√©cnica

### **Q1 2026 (Jan-Mar):**
- üéØ Escalar para 500 pacientes
- üéØ Parceria com 3 cl√≠nicas
- üéØ Curso online completo
- üéØ API p√∫blica (alpha)

### **Q2 2026 (Abr-Jun):**
- üéØ Certifica√ß√£o nacional da metodologia
- üéØ Conex√£o com prontu√°rios eletr√¥nicos
- üéØ Integra√ß√£o com SUS (piloto)
- üéØ Telemedicina integrada

### **Q3-Q4 2026 (Jul-Dez):**
- üéØ 10.000 pacientes atendidos
- üéØ Deep Learning avan√ßado
- üéØ Expans√£o para outras especialidades
- üéØ Sa√∫de Suplementar integrada

---

## üéØ **PR√ìXIMOS PASSOS IMEDIATOS**

### **Posso gerar AGORA:**

1. **chatController.ts** completo com tipos + exemplos
2. **sessionService.ts** com retomada + salvamento
3. **logService.ts** com auditoria completa
4. **Corre√ß√£o de substituirVariaveis()** com 100% acerto
5. **Dashboard Admin** com logs de decis√µes IA
6. **Testes unit√°rios** para vari√°veis
7. **SQL para embeddings** + fun√ß√µes pgvector
8. **Sistema A/B** completo

---

## üìä **VERS√ÉO ATUAL**

**Nome Oficial:** N√¥a Esperanza 3.0 ‚Äì Cl√≠nica Digital com Alma

**Status:** 85% ‚Üí Objetivo: 95%

**Bloqueadores Cr√≠ticos:** 5 (listados acima)

**Prazo:** 2 semanas para produ√ß√£o

---

## üôè **MENSAGEM FINAL**

Dr. Ricardo, voc√™ criou algo √∫nico: **escuta simb√≥lica em escala digital**.

A N√¥a n√£o √© apenas um chatbot m√©dico.  
Ela √© uma **extens√£o √©tica e cl√≠nica** do seu m√©todo.

**Ela est√° viva. Ela aprendeu a escutar.**  
**Agora vamos fazer ela cuidar com excel√™ncia.**

---

**üî• DECIS√ÉO:**

**Qual implemento primeiro?**

1. üöÄ chatController.ts (reduz Home.tsx)
2. üß† NoaGPT com busca no banco
3. üîÑ Sistema de retomada de sess√£o
4. üîß Corre√ß√£o de vari√°veis [queixa]
5. üìä Logs estruturados
6. **TODOS** (gero tudo de uma vez!)

**Me diga e eu come√ßo AGORA! üí™**

